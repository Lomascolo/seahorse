#!/bin/bash
# Copyright (c) 2016, CodiLime Inc.

if [ "$#" != "3" ]; then
    echo "Usage: ./prepare_docker-compose TEMPLATE TARGET DOCKER_TAG"
    exit 1
fi

TEMPLATE=$1
TARGET=$2
DOCKER_TAG=$3

DOCKER_REPOSITORY="docker-repo.deepsense.codilime.com/deepsense_io"

EXPOSED_SM_PORT=60100
EXPOSED_MQ_PORT=60101
EXPOSED_MQ_WEBSOCKET_PORT=60102
EXPOSED_WM_PORT=60103
EXPOSED_DB_PORT=60104
EXPOSED_NOTEBOOK_PORT=60105
EXPOSED_FRONTEND_PORT=60106
EXPOSED_LIBRARY_PORT=60107
EXPOSED_DATASOURCES_MANAGER_PORT=60108

rm -f $TARGET
cp $TEMPLATE $TARGET

sed -i 's|\$DOCKER_REPOSITORY|'"$DOCKER_REPOSITORY"'|g' $TARGET
sed -i 's|\$DOCKER_TAG|'"$DOCKER_TAG"'|g' $TARGET
sed -i 's|\$EXPOSED_SM_PORT|'"$EXPOSED_SM_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_MQ_PORT|'"$EXPOSED_MQ_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_MQ_WEBSOCKET_PORT|'"$EXPOSED_MQ_WEBSOCKET_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_WM_PORT|'"$EXPOSED_WM_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_DB_PORT|'"$EXPOSED_DB_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_NOTEBOOK_PORT|'"$EXPOSED_NOTEBOOK_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_FRONTEND_PORT|'"$EXPOSED_FRONTEND_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_LIBRARY_PORT|'"$EXPOSED_LIBRARY_PORT"'|g' $TARGET
sed -i 's|\$EXPOSED_DATASOURCES_MANAGER_PORT|'"$EXPOSED_DATASOURCES_MANAGER_PORT"'|g' $TARGET

DOCKERCOMPOSE_NETWORK_FILE="/etc/default/seahorse-dockercompose-network-settings"
if [ -f $DOCKERCOMPOSE_NETWORK_FILE ]; then
    cat $DOCKERCOMPOSE_NETWORK_FILE >> $TARGET
fi

VERSION_SBT_PATH=`dirname $0`"/../../version.sbt"
API_VERSION=`cat "$VERSION_SBT_PATH" | sed -n  's/version in ThisBuild := "\([0-9.]\+\).*/\1/p'`
if [ -z "$API_VERSION" ]; then
	echo "Couldn't gather API_VERSION from $VERSION_SBT_PATH"
	exit 3
fi
sed -i 's|\$API_VERSION|'"$API_VERSION"'|g' $TARGET

