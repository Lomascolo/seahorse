# Copyright (c) 2015, CodiLime Inc.

---
- name: Download WorkflowManager package
  hosts: localhost
  vars_files:
    - vars/deployment.yml
    - vars/artifacts.yml
    - vars/supervisor.yml
  tasks:
    - include: tasks/create_download_dir.yml
    - include: tasks/artifactory.yml artifactid={{wm_artifact_id}} version={{wm_build_version}}
    - include: tasks/download_supervisor.yml

- name: Perform cassandra migration
  hosts: cassandra
  user: ubuntu
  sudo: yes
  vars_files:
    - vars/deployment.yml
  roles:
    - { role: cassandra_migration,
        cql_dir: "{{wm_cql_dir}}",
        module: "workflowmanager"
      }

- name: Set up WorkflowManager application
  hosts: master
  user: ubuntu
  sudo: yes
  vars_files:
    - vars/deployment.yml
    - vars/artifacts.yml
    - vars/env.yml
    - vars/main.yml
    - vars/docker.yml
    - vars/supervisor.yml
  roles:
    - supervisor
    - { role: workflowmanager,
        install_dir: "{{wm_install_dir}}",
        akka_host: "{{master_host}}",
        wm_auth_service_password: "{{wm_service_password}}"
      }
