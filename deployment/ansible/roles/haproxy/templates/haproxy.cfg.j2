global
  log {{syslog_server_ip}} local0
  chroot /usr/local/etc/haproxy
  maxconn 4000
  user nobody
  group nogroup
  tune.ssl.default-dh-param 2048

defaults
  mode http
  log global
  option httplog
  option dontlognull
  option httpchk GET /
  timeout connect 3s
  timeout client 30s
  timeout server 30s
  timeout http-request 10s

frontend seahorse
  log global
  bind 0.0.0.0:80
  bind 0.0.0.0:443 ssl crt /usr/local/etc/haproxy/editor.seahorse.deepsense.io.pem crt /usr/local/etc/haproxy/deepsense.io.pem

  acl acl_editor hdr(Host) -i editor.deepsense.io editor.seahorse.deepsense.io
  acl acl_documentation hdr(Host) -i seahorse.deepsense.io
  acl acl_aws_health_check hdr_beg(User-Agent) -i Amazon\ Route\ 53\ Health\ Check\ Service
  acl acl_workflow_manager path_beg /v1/
  acl acl_workflow_manager path /version
  acl too_fast sc0_http_req_rate() gt {{static_allowed_http_req_rate_per_second_per_ip}}
  acl block_ip sc0_inc_gpc0 gt 0
  acl blocked_ip sc0_get_gpc0 gt 0

  stick-table type ip size 1m expire {{static_ip_block_period_in_seconds}}s store gpc0,http_req_rate(1s)

  tcp-request connection track-sc0 src
  tcp-request connection reject if blocked_ip
  http-request tarpit if !acl_workflow_manager too_fast block_ip

  http-request set-header User-Agent Amazon\ Route\ 53\ Health\ Check\ Service if acl_aws_health_check

  redirect scheme https code 301 if !{ ssl_fc }

  use_backend workflow_manager if acl_workflow_manager
  use_backend editor if acl_editor
  use_backend documentation if acl_documentation
  default_backend documentation

backend editor
  server ds_editor {{ds_editor_ip}}:{{ds_editor_port}} check

backend documentation
  server ds_documentation {{ds_documentation_ip}}:{{ds_documentation_port}} check

backend workflow_manager
  option httpchk GET / HTTP/1.1\r\nHost:\ editor.seahorse.deepsense.io
  http-check expect string Workflow\ Manager
  acl too_fast sc1_http_req_rate() gt {{wm_allowed_http_req_rate_per_second_per_ip}}
  acl block_ip sc1_inc_gpc0 gt 0
  acl blocked_ip sc1_get_gpc0 gt 0

  stick-table type ip size 1m expire 60s store gpc0,http_req_rate(1s)

  tcp-request content track-sc1 src
  tcp-request content reject if blocked_ip
  http-request tarpit if too_fast block_ip

  server ds_wm {{ds_wm_ip}}:{{ds_wm_port}} check

listen stats
  bind 0.0.0.0:8000
  mode http

  acl codi_office src 213.189.47.210/31 10.0.0.0/8 192.168.0.0/16 127.0.0.0/8 172.16.0.0/12

  stats enable
  stats uri /
  stats http-request allow if codi_office
  stats http-request deny
